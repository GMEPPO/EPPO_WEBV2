<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva contraseña - EPPO</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-warm, #F6F4F0);
            padding: 20px;
        }
        .login-box {
            background: #fff;
            border-radius: var(--radius, 14px);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg, 0 10px 26px rgba(13,42,60,.18));
            border: 1px solid #E8EBEF;
        }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: var(--brand-blue, #0D2A3C); font-size: 2rem; margin-bottom: 8px; }
        .login-header p { color: var(--text-muted, #5E6B76); font-size: 0.9rem; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; color: var(--text, #151719); margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-white, #ffffff);
            border: 1px solid #E8EBEF;
            border-radius: 8px;
            color: var(--text, #151719);
            font-size: 1rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--brand-blue, #0D2A3C);
            box-shadow: 0 0 0 3px rgba(13, 42, 60, 0.1);
        }
        .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--brand-blue, #0D2A3C);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-login:hover { background: #113B55; }
        .btn-login:disabled { opacity: 0.6; cursor: not-allowed; }
        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 0.9rem;
        }
        .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #dc2626; }
        .success-message { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #059669; }
        .error-message.show, .success-message.show { display: block; }
        .login-footer { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #E8EBEF; }
        .login-footer a { color: var(--brand-blue, #0D2A3C); text-decoration: none; font-size: 0.9rem; }
        .login-footer a:hover { text-decoration: underline; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 0.8s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .state-invalid-link { text-align: center; padding: 20px; color: var(--text-muted, #5E6B76); }
        .state-invalid-link a { color: var(--brand-blue, #0D2A3C); }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1><i class="fas fa-key"></i> Nueva contraseña</h1>
                <p id="headerSubtitle">Establece una nueva contraseña para tu cuenta</p>
            </div>

            <div id="stateInvalid" class="state-invalid-link" style="display: none;">
                <p>Este enlace ha expirado o no es válido.</p>
                <p><a href="login.html">Volver al inicio de sesión</a></p>
            </div>

            <div id="stateForm" style="display: none;">
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                <form id="resetForm">
                    <div class="form-group">
                        <label for="newPassword">Nueva contraseña</label>
                        <input type="password" id="newPassword" name="newPassword" placeholder="••••••••" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar contraseña</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="••••••••" required minlength="6" autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn-login" id="submitButton">
                        <span id="submitButtonText">Guardar contraseña</span>
                    </button>
                </form>
            </div>

            <div class="login-footer">
                <a href="login.html">Volver al inicio de sesión</a>
            </div>
        </div>
    </div>

    <script>
        // Detectar recuperación ANTES de que Supabase consuma el hash
        window.__isRecoveryRedirect = !!(location.hash && location.hash.indexOf('type=recovery') !== -1);
    </script>
    <script>
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function loadAllScripts() {
            try {
                await loadScript('https://unpkg.com/@supabase/supabase-js@2');
                await loadScript('load-config.js').catch(function() {});
                await new Promise(function(r) { setTimeout(r, 100); });
                await loadScript('supabase-config-universal.js');
                await loadScript('auth.js');
                initResetPage();
            } catch (error) {
                document.getElementById('stateInvalid').style.display = 'block';
                document.getElementById('stateInvalid').querySelector('p').textContent = 'Error al cargar. Recarga la página.';
            }
        }

        async function initResetPage() {
            await new Promise(function(r) { setTimeout(r, 200); });
            if (typeof window.authManager === 'undefined' || !window.authManager.initialize) {
                document.getElementById('stateInvalid').style.display = 'block';
                return;
            }
            try {
                await window.authManager.initialize();
            } catch (e) {}
            // Dar tiempo a que Supabase procese el hash y establezca la sesión
            await new Promise(function(r) { setTimeout(r, 800); });
            var hasSession = false;
            try {
                hasSession = await window.authManager.isAuthenticated();
            } catch (e) {}
            var showForm = window.__isRecoveryRedirect || hasSession;
            if (showForm) {
                document.getElementById('stateForm').style.display = 'block';
                document.getElementById('resetForm').addEventListener('submit', handleSubmit);
            } else {
                document.getElementById('stateInvalid').style.display = 'block';
            }
        }

        var isSubmitting = false;
        async function handleSubmit(e) {
            e.preventDefault();
            if (isSubmitting) return;
            var newP = document.getElementById('newPassword').value;
            var confirmP = document.getElementById('confirmPassword').value;
            var errorMsg = document.getElementById('errorMessage');
            var successMsg = document.getElementById('successMessage');
            var btn = document.getElementById('submitButton');
            var btnText = document.getElementById('submitButtonText');
            errorMsg.classList.remove('show');
            successMsg.classList.remove('show');
            if (newP.length < 6) {
                errorMsg.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                errorMsg.classList.add('show');
                return;
            }
            if (newP !== confirmP) {
                errorMsg.textContent = 'Las contraseñas no coinciden.';
                errorMsg.classList.add('show');
                return;
            }
            isSubmitting = true;
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span> Guardando...';
            try {
                var result = await window.authManager.updatePassword(newP);
                if (result.success) {
                    successMsg.textContent = 'Contraseña actualizada. Redirigiendo al inicio de sesión...';
                    successMsg.classList.add('show');
                    setTimeout(function() {
                        window.location.href = 'login.html?reset=1';
                    }, 1500);
                } else {
                    errorMsg.textContent = result.error || 'Error al actualizar la contraseña.';
                    errorMsg.classList.add('show');
                    btn.disabled = false;
                    btnText.textContent = 'Guardar contraseña';
                    isSubmitting = false;
                }
            } catch (err) {
                errorMsg.textContent = err.message || 'Error al actualizar la contraseña.';
                errorMsg.classList.add('show');
                btn.disabled = false;
                btnText.textContent = 'Guardar contraseña';
                isSubmitting = false;
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadAllScripts);
        } else {
            loadAllScripts();
        }
    </script>
</body>
</html>
