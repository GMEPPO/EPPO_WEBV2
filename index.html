<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPPO by Groupe GM - Categor√≠as de Productos</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="menu-hamburguesa.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="load-config.js"></script>
    <script src="supabase-config-universal.js"></script>
    <script src="translation-system.js"></script>
    <script src="auth.js"></script>
    <script src="roles.js"></script>
    <script src="debug-auth.js"></script>
    <script src="stock-warning.js"></script>
    <style>
        /* Hero Section para Categor√≠as - m√°s compacto */
        .comparison-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 50px 0;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .comparison-hero h1 {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .comparison-hero p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        /* Mejorar las tarjetas de categor√≠as - formato cuadrado y compacto */
        .category-card {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 12px rgba(13,42,60,.15);
            aspect-ratio: 1 / 1; /* Formato cuadrado */
            display: block;
        }

        .category-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 28px rgba(13,42,60,.22);
        }

        .category-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.4s ease;
        }

        .category-card:hover img {
            transform: scale(1.08);
        }

        .category-card .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: flex-end;
            padding: 16px;
            color: #fff;
            background: linear-gradient(180deg, rgba(0,0,0,0) 40%, rgba(0,0,0,.7) 100%);
        }

        .category-card .title {
            font-family: "Playfair Display", serif;
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 0 2px 6px rgba(0,0,0,0.6);
            letter-spacing: 0.02em;
        }

        /* Grid de categor√≠as - m√°ximo 4 por fila */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 28px;
            margin-top: 30px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }

        /* Limitar a 4 columnas m√°ximo en pantallas grandes */
        @media (min-width: 1100px) {
            .categories-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* 3 columnas en tablets grandes */
        @media (max-width: 1099px) and (min-width: 769px) {
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .comparison-hero h1 {
                font-size: 2.5rem;
            }
            
            .categories-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                max-width: 100%;
            }
            
            .category-card .title {
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 500px) {
            .categories-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .category-card .title {
                font-size: 0.9rem;
            }
            
            .category-card .overlay {
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span>EPPO by <span class="groupe-gm">Groupe GM</span></span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="productos-dinamico.html" class="nav-link">Products</a>
                <a href="carrito-compras.html" class="nav-link" id="nav-cart-link">Presupuesto</a>
                <a href="consultar-propuestas.html" class="nav-link" id="nav-proposals-link">Hist√≥rico</a>
                
                <!-- Men√∫ hamburguesa -->
                <div class="menu-dropdown">
                    <button class="menu-toggle" id="menuToggle" onclick="toggleMenu()" aria-label="Toggle menu">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="comparar-productos.html" class="dropdown-link">
                            <i class="fas fa-balance-scale"></i>
                            <span>Comparar</span>
                        </a>
                        <a href="selector-productos.html" class="dropdown-link" id="nav-create-product-link">
                            <i class="fas fa-edit"></i>
                            <span id="create-product-text">Creador/Editor</span>
                        </a>
                    </div>
                </div>
                
                <div class="language-selector">
                    <button class="flag-btn active" data-lang="pt" title="Portugu√™s" onclick="changeLanguage('pt')">
                        <img src="https://flagcdn.com/w20/pt.png" alt="Portugal">
                    </button>
                    <button class="flag-btn" data-lang="es" title="Espa√±ol" onclick="changeLanguage('es')">
                        <img src="https://flagcdn.com/w20/es.png" alt="Espa√±a">
                    </button>
                    <button class="flag-btn" data-lang="en" title="English" onclick="changeLanguage('en')">
                        <img src="https://flagcdn.com/w20/gb.png" alt="Reino Unido">
                    </button>
                </div>
                <button class="theme-toggle" id="theme-toggle" title="Cambiar tema">
                    <i class="fas fa-sun sun-icon"></i>
                    <i class="fas fa-moon moon-icon"></i>
                </button>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="comparison-hero">
        <div class="container">
            <h1>Categorias</h1>
            <p>Descubre nuestra amplia gama de productos para hoteles</p>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
        <section class="container" style="padding:32px 0">
            <div class="categories-grid" id="categoriesGrid">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>Cargando categor√≠as...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Funci√≥n para manejar el cambio de tema
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Actualizar el t√≠tulo del bot√≥n
            const toggleButton = document.getElementById('theme-toggle');
            toggleButton.setAttribute('title', newTheme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
        }

        // Funci√≥n para inicializar el tema
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            document.documentElement.setAttribute('data-theme', theme);
            
            const toggleButton = document.getElementById('theme-toggle');
            toggleButton.setAttribute('title', theme === 'dark' ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            
            const toggleButton = document.getElementById('theme-toggle');
            if (toggleButton) {
                toggleButton.addEventListener('click', toggleTheme);
            }
        });

        // Escuchar cambios en las preferencias del sistema
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            if (!localStorage.getItem('theme')) {
                const theme = e.matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
            }
        });

        // Funci√≥n para cambiar idioma
        // NO sobrescribir la funci√≥n global changeLanguage
        // En su lugar, escuchar el evento languageChanged para actualizar elementos espec√≠ficos
        window.addEventListener('languageChanged', function(event) {
            const lang = event.detail.language;
            updatePageContent(lang);
            updateNavigationButtons(lang);
        });
        
        // Funci√≥n local solo para inicializaci√≥n (no sobrescribe la global)
        function initPageLanguage() {
            const savedLanguage = localStorage.getItem('language') || 'pt';
            updatePageContent(savedLanguage);
            updateNavigationButtons(savedLanguage);
        }

        // Funci√≥n para actualizar el contenido de la p√°gina seg√∫n el idioma
        function updatePageContent(lang) {
            const translations = {
                pt: {
                    title: 'Categorias',
                    subtitle: 'Descubra nossa ampla gama de produtos para hot√©is',
                    secadores: 'Secadores',
                    planchado: 'Passar a ferro',
                    portamaletas: 'Porta-malas'
                },
                es: {
                    title: 'Categor√≠as',
                    subtitle: 'Descubre nuestra amplia gama de productos para hoteles',
                    secadores: 'Secadores',
                    planchado: 'Planchado',
                    portamaletas: 'Portamaletas'
                },
                en: {
                    title: 'Categories',
                    subtitle: 'Discover our wide range of products for hotels',
                    secadores: 'Hair Dryers',
                    planchado: 'Ironing',
                    portamaletas: 'Luggage Racks'
                }
            };

            const t = translations[lang] || translations.pt;
            
            // Actualizar t√≠tulo y subt√≠tulo
            const titleElement = document.querySelector('.comparison-hero h1');
            const subtitleElement = document.querySelector('.comparison-hero p');
            
            if (titleElement) titleElement.textContent = t.title;
            if (subtitleElement) subtitleElement.textContent = t.subtitle;
            
            // Actualizar t√≠tulos de categor√≠as
            const categoryTitles = document.querySelectorAll('.category-card .title');
            if (categoryTitles.length >= 3) {
                categoryTitles[0].textContent = t.secadores;
                categoryTitles[1].textContent = t.planchado;
                categoryTitles[2].textContent = t.portamaletas;
            }
            
            // Actualizar botones de navegaci√≥n
            updateNavigationButtons(lang);
        }
        
        // Funci√≥n para actualizar botones de navegaci√≥n
        function updateNavigationButtons(lang) {
            const navTranslations = {
                pt: {
                    budget: 'Or√ßamento',
                    history: 'Hist√≥rico',
                    createProduct: 'Criador/Editor',
                    home: 'Home',
                    products: 'Products'
                },
                es: {
                    budget: 'Presupuesto',
                    history: 'Hist√≥rico',
                    createProduct: 'Creador/Editor',
                    home: 'Home',
                    products: 'Products'
                },
                en: {
                    budget: 'Budget',
                    history: 'History',
                    createProduct: 'Creator/Editor',
                    home: 'Home',
                    products: 'Products'
                }
            };
            
            const t = navTranslations[lang] || navTranslations.pt;
            
            // Actualizar enlaces de navegaci√≥n
            const cartLink = document.getElementById('nav-cart-link');
            const proposalsLink = document.getElementById('nav-proposals-link');
            const createProductLink = document.getElementById('create-product-text');
            const homeLink = document.querySelector('a[href="index.html"].nav-link');
            const productsLink = document.querySelector('a[href="productos-dinamico.html"].nav-link');
            
            if (cartLink) cartLink.textContent = t.budget;
            if (proposalsLink) {
                // Ahora es un link directo, no tiene span dentro
                proposalsLink.textContent = t.history;
            }
            if (createProductLink) createProductLink.textContent = t.createProduct;
            if (homeLink) homeLink.textContent = t.home;
            if (productsLink) productsLink.textContent = t.products;
        }

        // Variables globales
        let supabaseClient = null;
        let homeCategories = [];

        // Inicializar Supabase - usar siempre el cliente compartido
        async function initSupabase() {
            try {
                if (supabaseClient) {
                    return supabaseClient;
                }

                // Asegurar que universalSupabase est√© disponible
                if (!window.universalSupabase) {
                    console.warn('universalSupabase no disponible, esperando...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (window.universalSupabase) {
                    supabaseClient = await window.universalSupabase.getClient();
                    if (supabaseClient) {
                        console.log('‚úÖ Supabase inicializado correctamente');
                        return supabaseClient;
                    }
                }
                
                console.error('‚ùå No se pudo inicializar Supabase');
                return null;
            } catch (error) {
                console.error('‚ùå Error al inicializar Supabase:', error);
                return null;
            }
        }

        // Cargar categor√≠as del home desde Supabase
        async function loadHomeCategories() {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) {
                console.error('‚ùå No se encontr√≥ el elemento categoriesGrid');
                return;
            }

            // Mostrar indicador de carga
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Cargando categor√≠as...</p></div>';

            console.log('üîÑ Inicializando Supabase...');
            const client = await initSupabase();
            if (!client) {
                console.error('‚ùå No se pudo obtener el cliente de Supabase');
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-danger);"><p>Error al conectar con la base de datos. Por favor, recarga la p√°gina.</p></div>';
                return;
            }

            try {
                console.log('üîÑ Cargando categor√≠as desde Supabase...');
                console.log('üìã Tabla: categorias_geral');
                console.log('üìã Filtros: tipo=home, is_active=true');
                
                // Cargar solo categor√≠as activas, ordenadas por orden
                const { data, error } = await client
                    .from('categorias_geral')
                    .select('*')
                    .eq('tipo', 'home')
                    .eq('is_active', true)
                    .order('orden', { ascending: true });

                console.log('üìä Respuesta de Supabase recibida');
                console.log('üìä Data:', data);
                console.log('üìä Error:', error);

                if (error) {
                    console.error('‚ùå Error de Supabase:', error);
                    console.error('‚ùå C√≥digo de error:', error.code);
                    console.error('‚ùå Mensaje:', error.message);
                    console.error('‚ùå Detalles:', error.details);
                    console.error('‚ùå Hint:', error.hint);
                    
                    // Si es error de permisos RLS, mostrar mensaje espec√≠fico
                    if (error.code === '42501' || error.message?.includes('permission denied') || error.message?.includes('row-level security')) {
                        grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-danger);"><p>‚ùå Error de permisos en la base de datos</p><p style="margin-top: 10px; font-size: 0.9rem;">Necesitas configurar las pol√≠ticas RLS en Supabase para permitir lectura de categorias_geral a usuarios autenticados.</p><p style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary);">Consulta SOLUCION-CATEGORIAS.md para m√°s informaci√≥n.</p></div>';
                        return;
                    }
                    
                    throw error;
                }

                homeCategories = data || [];
                console.log(`‚úÖ Categor√≠as cargadas: ${homeCategories.length}`);

                // Categor√≠as cargadas
                if (homeCategories.length > 0) {
                    homeCategories.forEach(cat => {
                        console.log(`  - ${cat.nombre_es}: foto = "${cat.foto}"`);
                    });
                }

                if (homeCategories.length === 0) {
                    console.warn('‚ö†Ô∏è No hay categor√≠as disponibles en la base de datos');
                    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>No hay categor√≠as disponibles. Contacta al administrador.</p></div>';
                    return;
                }

                // Renderizar categor√≠as
                console.log('üîÑ Renderizando categor√≠as...');
                renderHomeCategories();
                console.log('‚úÖ Categor√≠as renderizadas correctamente');
            } catch (error) {
                console.error('‚ùå Error cargando categor√≠as del home:', error);
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-danger);"><p>Error al cargar las categor√≠as: ' + (error.message || 'Error desconocido') + '</p><p style="margin-top: 10px; font-size: 0.9rem;">Por favor, recarga la p√°gina.</p></div>';
            }
        }

        // Renderizar categor√≠as en el grid
        function renderHomeCategories() {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) return;

            const currentLang = localStorage.getItem('language') || 'pt';

            let html = '';
            homeCategories.forEach(category => {
                // Obtener nombre seg√∫n idioma
                const nombre = currentLang === 'es' ? category.nombre_es : 
                              currentLang === 'pt' ? category.nombre_pt : 
                              category.nombre_es; // Fallback a espa√±ol

                // URL de destino con par√°metro de categor√≠a para filtrar autom√°ticamente
                const categorySlug = category.nombre_es.toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/[^a-z0-9-]/g, '');
                const href = `productos-dinamico.html?category=${categorySlug}`;

                // Debug: mostrar en consola qu√© foto se est√° usando
                console.log('Categor√≠a:', category.nombre_es, 'Foto en BD:', category.foto);

                // Validar que la foto existe y no est√° vac√≠a
                const fotoUrl = category.foto && category.foto.trim() ? category.foto.trim() : null;

                html += `
                    <a class="category-card" href="${href}" data-category-id="${category.id}" data-category-name="${category.nombre_es}" data-foto-url="${fotoUrl || ''}">
                        ${fotoUrl ? 
                            `<img src="${fotoUrl}" alt="${nombre}" 
                                onerror="console.error('‚ùå Error cargando imagen para categor√≠a ${category.nombre_es}:', '${fotoUrl}'); this.style.display='none';" 
                                onload="console.log('‚úÖ Imagen cargada correctamente para ${category.nombre_es}:', '${fotoUrl}');"
                                loading="lazy"
                                data-foto-original="${fotoUrl}">` :
                            `<div style="width: 100%; height: 100%; background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%); display: flex; align-items: center; justify-content: center; color: #9ca3af;">
                                <i class="fas fa-image" style="font-size: 2.5rem;"></i>
                            </div>`
                        }
                        <div class="overlay">
                            <div class="title">${nombre}</div>
                        </div>
                    </a>
                `;
            });

            grid.innerHTML = html || '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><p>No hay categor√≠as disponibles</p></div>';
            
            // Agregar event listeners para depuraci√≥n al hacer clic en las categor√≠as
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    const categoryId = this.getAttribute('data-category-id');
                    const categoryName = this.getAttribute('data-category-name');
                    const fotoUrl = this.getAttribute('data-foto-url');
                    const img = this.querySelector('img');
                    const imgSrc = img ? img.src : 'No hay imagen';
                    const imgDataOriginal = img ? img.getAttribute('data-foto-original') : 'No hay imagen';
                    
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üñºÔ∏è INFORMACI√ìN DE LA CATEGOR√çA CLICKEADA:');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                    console.log('üìù Nombre:', categoryName);
                    console.log('üÜî ID:', categoryId);
                    console.log('üíæ Foto en Base de Datos (data-foto-url):', fotoUrl);
                    console.log('üñºÔ∏è Foto Original (data-foto-original):', imgDataOriginal);
                    console.log('üåê URL Actual de la Imagen (img.src):', imgSrc);
                    console.log('üîç ¬øCoinciden?', fotoUrl === imgSrc || imgDataOriginal === imgSrc ? '‚úÖ S√ç' : '‚ùå NO');
                    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
                });
            });
        }

        // Actualizar categor√≠as cuando cambia el idioma
        function updatePageContent(lang) {
            const translations = {
                pt: {
                    title: 'Categorias',
                    subtitle: 'Descubra nossa ampla gama de produtos para hot√©is'
                },
                es: {
                    title: 'Categor√≠as',
                    subtitle: 'Descubre nuestra amplia gama de productos para hoteles'
                },
                en: {
                    title: 'Categories',
                    subtitle: 'Discover our wide range of products for hotels'
                }
            };

            const t = translations[lang] || translations.pt;
            
            // Actualizar t√≠tulo y subt√≠tulo
            const titleElement = document.querySelector('.comparison-hero h1');
            const subtitleElement = document.querySelector('.comparison-hero p');
            
            if (titleElement) titleElement.textContent = t.title;
            if (subtitleElement) subtitleElement.textContent = t.subtitle;
            
            // Re-renderizar categor√≠as con el nuevo idioma
            if (homeCategories.length > 0) {
                renderHomeCategories();
            }
            
            // Actualizar botones de navegaci√≥n
            updateNavigationButtons(lang);
        }

        // Inicializar idioma y cargar categor√≠as al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ DOMContentLoaded - Iniciando carga de index.html');
            
            // Verificar si ya estamos en proceso de redirecci√≥n (evitar bucles)
            const redirectFlag = sessionStorage.getItem('auth_redirecting');
            if (redirectFlag === 'true') {
                console.log('‚ö†Ô∏è Redirecci√≥n en curso, esperando...');
                sessionStorage.removeItem('auth_redirecting');
                // Esperar un momento antes de verificar de nuevo
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Verificar autenticaci√≥n primero (pero no bloquear si hay problemas)
            console.log('üîê Verificando autenticaci√≥n...');
            let isAuth = false;
            
            // Si estamos usando file://, mostrar mensaje claro
            if (window.location.protocol === 'file:') {
                console.error('‚ùå PROBLEMA: Est√°s usando file:// protocol');
                console.error('‚ùå Supabase NO puede autenticar usuarios con file://');
                console.error('');
                console.error('üí° SOLUCI√ìN: Usa un servidor HTTP local');
                console.error('   1. Abre PowerShell o CMD en esta carpeta');
                console.error('   2. Ejecuta: python -m http.server 8000');
                console.error('   3. Abre en el navegador: http://localhost:8000');
                console.error('');
                console.warn('‚ö†Ô∏è Continuando sin autenticaci√≥n (funcionalidad limitada)');
            }
            
            // Esperar un momento para que authManager se inicialice completamente
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Verificar autenticaci√≥n de forma optimizada
            try {
                if (window.authManager && typeof window.authManager.isAuthenticated === 'function') {
                    // La funci√≥n isAuthenticated ya tiene su propio timeout interno
                    isAuth = await window.authManager.isAuthenticated();
                } else {
                    console.warn('‚ö†Ô∏è authManager no disponible');
                    isAuth = false;
                }
                
                if (window.location.protocol === 'file:') {
                    console.log('üîê Estado: No autenticado (esperado con file://)');
                } else {
                    console.log('üîê Estado de autenticaci√≥n:', isAuth ? '‚úÖ Autenticado' : '‚ö†Ô∏è No autenticado');
                }
                
                // Solo redirigir si NO estamos usando file:// y NO est√° autenticado
                // Y solo si no hay una bandera de redirecci√≥n activa
                if (!isAuth && window.location.protocol !== 'file:') {
                    // Verificar que no estemos ya en login.html
                    const currentPath = window.location.pathname || window.location.href;
                    if (!currentPath.includes('login.html')) {
                        // Verificar que no hayamos redirigido recientemente
                        const lastRedirect = sessionStorage.getItem('last_auth_redirect');
                        const now = Date.now();
                        if (!lastRedirect || (now - parseInt(lastRedirect)) > 2000) {
                            console.log('‚ùå Usuario no autenticado, redirigiendo a login...');
                            sessionStorage.setItem('auth_redirecting', 'true');
                            sessionStorage.setItem('last_auth_redirect', now.toString());
                            window.location.href = 'login.html';
                            return;
                        } else {
                            console.warn('‚ö†Ô∏è Redirecci√≥n reciente detectada, evitando bucle');
                        }
                    }
                }
            } catch (error) {
                if (window.location.protocol !== 'file:') {
                    console.error('‚ö†Ô∏è Error verificando autenticaci√≥n (continuando):', error);
                }
                // Continuar aunque haya error en autenticaci√≥n
            }
            
            console.log('‚úÖ Continuando con la carga de la p√°gina...');

            // NOTA: El rol se carga autom√°ticamente en auth.js cuando hay SIGNED_IN
            // Aqu√≠ solo esperamos a que el rol est√© cargado y deshabilitamos el men√∫
            // NO cargamos el rol aqu√≠ para evitar consultas duplicadas
            if (isAuth && window.rolesManager) {
                // Ejecutar de forma as√≠ncrona sin bloquear la carga de la p√°gina
                (async () => {
                    try {
                        console.log('üîÑ [index.html] Usuario ya autenticado, esperando a que el rol se cargue...');
                        
                        // NO inicializar rolesManager aqu√≠ - auth.js ya lo hace
                        // Solo esperar a que el rol est√© disponible
                        let role = null;
                        let retries = 0;
                        const maxRetries = 20; // 4 segundos m√°ximo (200ms * 20)
                        
                        while (!role && retries < maxRetries) {
                            // Esperar a que auth.js cargue el rol
                            if (window.rolesManager.currentUserRole) {
                                role = window.rolesManager.currentUserRole;
                                break;
                            }
                            
                            // Si hay una carga en curso, esperar a que termine
                            if (window.rolesManager.roleLoadPromise) {
                                role = await window.rolesManager.roleLoadPromise;
                                break;
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 200));
                            retries++;
                        }
                        
                        // Si a√∫n no hay rol, obtenerlo (pero solo si no hay carga en curso)
                        if (!role && !window.rolesManager.isLoadingRole) {
                            role = await window.rolesManager.getCurrentUserRole();
                        }
                        
                        if (role) {
                            console.log('üîê [index.html] Rol obtenido:', role);
                            
                            // Deshabilitar men√∫ para usuarios comerciales
                            if (typeof window.disableMenuForComercial === 'function') {
                                console.log('üîÑ [index.html] Ejecutando disableMenuForComercial...');
                                await window.disableMenuForComercial();
                            }
                        } else {
                            console.warn('‚ö†Ô∏è [index.html] No se pudo obtener el rol, se intentar√° cuando se dispare roleLoaded');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è [index.html] Error esperando rol (continuando):', error);
                    }
                })();
            } else {
                console.log('‚è≠Ô∏è [index.html] Saltando espera de rol:', {
                    isAuth: isAuth,
                    hasRolesManager: !!window.rolesManager
                });
            }

            // Configurar idioma (no bloquea)
            // La funci√≥n global changeLanguage se inicializa autom√°ticamente desde translation-system.js
            // Solo inicializar elementos espec√≠ficos de esta p√°gina
            initPageLanguage();
            
            // Inicializar Supabase y cargar categor√≠as del home
            // IMPORTANTE: Esto se ejecuta INMEDIATAMENTE, sin esperar a rolesManager
            console.log('üîÑ Iniciando carga de categor√≠as (sin bloqueo por roles)...');
            try {
                await initSupabase();
                await loadHomeCategories();
            } catch (error) {
                console.error('‚ùå Error inicializando Supabase o cargando categor√≠as:', error);
                console.error('‚ùå Stack trace:', error.stack);
                const grid = document.getElementById('categoriesGrid');
                if (grid) {
                    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-danger);"><p>Error al cargar las categor√≠as. Por favor, recarga la p√°gina.</p><p style="margin-top: 10px; font-size: 0.9rem;">Error: ' + (error.message || 'Desconocido') + '</p></div>';
                }
            }
        });
    </script>
    <script src="menu-hamburguesa.js"></script>
    <script src="theme-common.js"></script>
</body>
</html>
